{"version":3,"sources":["webpack://Posc/webpack/bootstrap","webpack://Posc/./src/http-client.ts","webpack://Posc/./src/policy-store.ts","webpack://Posc/./src/state-store.ts","webpack://Posc/./src/policy-mananger.ts","webpack://Posc/./index.ts"],"names":[],"mappings":"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","file":"policy-server.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","export class HttpClient {\r\n\r\n    public get<T>(url: string, args?: { [key: string]: string }): Promise<T> {\r\n        return this.getRequest(url, args).then(p => {\r\n            return Object.assign({} as T, JSON.parse(HttpClient.toLowerKey(p)));\r\n        });\r\n    }\r\n\r\n    public getRequest(url: string, args?: { [key: string]: string }): Promise<any> {\r\n        return new Promise<any>(function (resolve, reject) {\r\n            const request = new XMLHttpRequest();\r\n            request.onload = function () {\r\n                if (this.status === 200) {\r\n                    resolve(this.response);\r\n                } else {\r\n                    reject(new Error(this.statusText));\r\n                }\r\n            };\r\n            request.onerror = function () {\r\n                reject(new Error('XMLHttpRequest Error: ' + this.statusText));\r\n            };\r\n            request.open('GET', url);\r\n            if (args != null) {\r\n                for (const arg in args) {\r\n                    request.setRequestHeader(arg, args[arg]);\r\n                }\r\n            }\r\n            request.send();\r\n        });\r\n    }\r\n\r\n    public static toLowerKey(json: string): string {\r\n        return json.replace(/\"([\\w]+)\":/g, function ($0, $1) {\r\n            return ('\"' + HttpClient.toFirstLowerCase($1) + '\":');\r\n        });\r\n    }\r\n\r\n    public static toFirstLowerCase(src: string): string {\r\n        return src.charAt(0).toLowerCase() + src.slice(1);\r\n    }\r\n\r\n}","import { Permission } from \"./models\";\r\nimport { HttpClient } from \"./http-client\";\r\n\r\nexport class PolicyStore {\r\n\r\n    private readonly _http: HttpClient;\r\n\r\n    constructor(httpClient?: HttpClient) {\r\n        this._http = httpClient != null ? httpClient : new HttpClient();\r\n    }\r\n\r\n    public getPolicy(url: string, cliendId: string, token: string): Promise<Permission> {\r\n        return this._http.get<Permission>(`${url}?clientId=${cliendId}`, {\r\n            Authorization: 'Bearer ' + token\r\n        });\r\n    }\r\n\r\n}\r\n","export class StateStore {\r\n\r\n    private readonly _prefix: string;\r\n    private readonly _store: Storage;\r\n\r\n    constructor(args: { prefix: string, store: Storage } = { prefix: 'posc.', store: sessionStorage }) {\r\n        this._prefix = args.prefix;\r\n        this._store = args.store;\r\n    }\r\n\r\n    set(key: string, value: string) {\r\n        key = this._prefix + key;\r\n        this._store.setItem(key, value);\r\n        return Promise.resolve();\r\n    }\r\n\r\n    get(key: string): Promise<string> {\r\n        key = this._prefix + key;\r\n        let item = this._store.getItem(key);\r\n        return Promise.resolve(item);\r\n    }\r\n\r\n    remove(key: string) {\r\n        key = this._prefix + key;\r\n        let item = this._store.getItem(key);\r\n        this._store.removeItem(key);\r\n        return Promise.resolve(item);\r\n    }\r\n\r\n    getAllKeys() {\r\n        const keys = [];\r\n        for (let index = 0; index < this._store.length; index++) {\r\n            let key = this._store.key(index);\r\n\r\n            if (key.indexOf(this._prefix) === 0) {\r\n                keys.push(key.substr(this._prefix.length));\r\n            }\r\n        }\r\n\r\n        return Promise.resolve(keys);\r\n    }\r\n\r\n}","import { PolicyManagerSettings } from \"./policy-manager.settings\";\r\nimport { PolicyStore } from \"./policy-store\";\r\nimport { Permission, Dicovery } from \"./models\";\r\nimport { HttpClient } from \"./http-client\";\r\nimport { StateStore } from \"./state-store\";\r\n\r\nexport class PolicyManager {\r\n\r\n    private readonly _http: HttpClient = new HttpClient();\r\n\r\n    public readonly settings: PolicyManagerSettings;\r\n    private readonly _defaultSettings: PolicyManagerSettings = <PolicyManagerSettings> {\r\n        authority: undefined,\r\n        requireHttpsMetadata: true,\r\n        endpoints: {\r\n            discovery: '.well-known/policy-configuration',\r\n            permission: undefined,\r\n            policy: undefined\r\n        },\r\n        policyStore: new PolicyStore(this._http),\r\n        stateStore: new StateStore()\r\n    };\r\n\r\n    private _loaded: boolean = false;\r\n    private _token: string;\r\n\r\n    constructor(settings?: PolicyManagerSettings) {\r\n        this.settings = Object.assign(this._defaultSettings, settings);\r\n    }\r\n\r\n    public setToken(token: string) {\r\n        this._token = token;\r\n    }\r\n    public removeToken() {\r\n        this._token = null;\r\n    }\r\n\r\n    public getPolicy(): Promise<Permission> {\r\n        const key = `permision:${this.settings.authority}:${this.settings.clientId}`;\r\n        return this.getPermssionEndpoint().then(url => {\r\n            return this.settings.stateStore.get(key).then(strPermission => {\r\n                const currentPermission = strPermission != null ? JSON.parse(strPermission) as Permission : null;\r\n                const hasCacheData = currentPermission != null && new Date().getTime() <= (currentPermission.created + (currentPermission.expireIn * 1000));\r\n                if (hasCacheData) {\r\n                    return new Promise<Permission>(r => { r(currentPermission); })\r\n                } else {\r\n                    return this.settings.policyStore.getPolicy(url, this.settings.clientId, this._token).then(newPermssion => {\r\n                        newPermssion.created = new Date().getTime();\r\n                        this.settings.stateStore.set(key, JSON.stringify(newPermssion));\r\n                        return newPermssion;\r\n                    });\r\n                }\r\n            });\r\n        });\r\n    }\r\n\r\n    public removePolicy() {\r\n        const key = `permision:${this.settings.authority}:${this.settings.clientId}`;\r\n        this.settings.stateStore.remove(key);\r\n    }\r\n\r\n    public getPermssionEndpoint(): Promise<string> {\r\n        if (this.settings.endpoints.permission != null) {\r\n            return new Promise<string>(r => r(this.settings.endpoints.permission));\r\n        }\r\n\r\n        return this._http.get<Dicovery>(`${this.settings.authority}/${this.settings.endpoints.discovery}`).then(p => {\r\n            this.settings.endpoints.permission = p.permissionEndpoint;\r\n            this.settings.endpoints.policy = p.policyEndpoint;\r\n            return p.permissionEndpoint;\r\n        });\r\n    }\r\n\r\n}\r\n","import { PolicyManager } from './src/policy-mananger';\r\nimport { PolicyManagerSettings, PolicyManagerEndpointSettings } from './src/policy-manager.settings';\r\nimport { Dicovery } from './src/models';\r\nimport { PolicyStore } from './src/policy-store';\r\nimport { StateStore } from './src/state-store';\r\n\r\nexport {\r\n    PolicyManagerSettings,\r\n    PolicyManagerEndpointSettings,\r\n    Dicovery,\r\n    PolicyStore,\r\n    StateStore,\r\n    PolicyManager,\r\n}"],"sourceRoot":""}